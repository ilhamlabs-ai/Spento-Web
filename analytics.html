<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Spento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #5B9FED 0%, #5DD5C3 100%); }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Top Navigation -->
    <nav class="gradient-bg text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center max-w-4xl">
            <h1 class="text-2xl font-bold">Analytics</h1>
            <select id="periodSelector" class="bg-white/20 text-white border border-white/30 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-white/50">
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="180">Last 6 Months</option>
                <option value="365">Last Year</option>
            </select>
        </div>
    </nav>

    <div class="container mx-auto p-4 pb-24 max-w-4xl">
        
        <!-- Main Stats Card -->
        <div class="gradient-bg rounded-2xl p-6 mb-6 text-white shadow-lg">
            <div class="text-sm opacity-90 mb-2">Spending - <span id="periodText">30 days</span></div>
            <div class="text-5xl font-bold mb-2">â‚¬<span id="totalSpending">0</span></div>
            <div class="text-sm opacity-90"><span id="billCount">0</span> bills</div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-50 rounded-2xl p-4 text-center">
                <svg class="w-8 h-8 mx-auto mb-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <div class="text-2xl font-bold text-blue-700">â‚¬<span id="avgBill">0</span></div>
                <div class="text-xs text-blue-600 font-medium">Average Bill</div>
            </div>
            
            <div class="bg-purple-50 rounded-2xl p-4 text-center">
                <svg class="w-8 h-8 mx-auto mb-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                </svg>
                <div class="text-2xl font-bold text-purple-700"><span id="categoryCount">0</span></div>
                <div class="text-xs text-purple-600 font-medium">Categories</div>
            </div>
            
            <div class="bg-pink-50 rounded-2xl p-4 text-center">
                <svg class="w-8 h-8 mx-auto mb-2 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
                <div class="text-2xl font-bold text-pink-700"><span id="frequency">0</span>/day</div>
                <div class="text-xs text-pink-600 font-medium">Frequency</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-2xl p-2 flex space-x-2 mb-6 shadow-lg">
            <button id="categoryTab" class="flex-1 py-2 rounded-xl font-semibold transition bg-blue-100 text-blue-600">Category</button>
            <button id="timelineTab" class="flex-1 py-2 rounded-xl font-semibold transition text-gray-600">Timeline</button>
            <button id="weeklyTab" class="flex-1 py-2 rounded-xl font-semibold transition text-gray-600">Weekly</button>
        </div>

        <!-- Category View -->
        <div id="categoryView" class="bg-white rounded-2xl p-6 shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Category Analysis</h2>
            <div class="h-72">
                <canvas id="categoryChart"></canvas>
            </div>
            <div id="categoryDetails" class="mt-6 space-y-3">
                <!-- Category details will be loaded here -->
            </div>
        </div>

        <!-- Timeline View -->
        <div id="timelineView" class="hidden bg-white rounded-2xl p-6 shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Spending Timeline</h2>
            <div class="h-72">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- Weekly View -->
        <div id="weeklyView" class="hidden bg-white rounded-2xl p-6 shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Weekly Pattern</h2>
            <div class="h-72">
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 shadow-lg">
        <div class="container mx-auto flex justify-around items-center max-w-4xl">
            <a href="dashboard.html" class="flex flex-col items-center text-gray-500">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                <span class="text-xs mt-1">Dashboard</span>
            </a>
            <a href="upload.html" class="flex flex-col items-center text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                <span class="text-xs mt-1">Upload</span>
            </a>
            <a href="bills.html" class="flex flex-col items-center text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <span class="text-xs mt-1">Bills</span>
            </a>
            <a href="analytics.html" class="flex flex-col items-center text-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <span class="text-xs mt-1 font-medium">Analytics</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC6QYvm6Y_lb7aO_v2bSepXZ6qxBxkkuyE",
            authDomain: "biller-app-13fb1.firebaseapp.com",
            projectId: "biller-app-13fb1",
            storageBucket: "biller-app-13fb1.firebasestorage.app",
            messagingSenderId: "563377160023",
            appId: "1:563377160023:web:533869f1ed33b2bfe6c812",
            measurementId: "G-NLT1KF5B10"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const categoryIcons = { grocery: 'ðŸ›’', utensil: 'ðŸ´', clothing: 'ðŸ‘•', miscellaneous: 'ðŸ“¦' };
        const categoryColors = { grocery: '#10b981', utensil: '#3b82f6', clothing: '#ec4899', miscellaneous: '#f59e0b' };

        let allBills = [];
        let currentPeriod = 30;
        let charts = {};

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            await loadAnalytics(user.uid);
        });

        async function loadAnalytics(userId) {
            try {
                const billsRef = collection(db, 'bills');
                const q = query(billsRef, where('ownerId', '==', userId));
                const snapshot = await getDocs(q);
                
                allBills = [];
                snapshot.forEach(doc => {
                    allBills.push({ id: doc.id, ...doc.data() });
                });

                filterAndAnalyze();
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function filterAndAnalyze() {
            const now = new Date();
            const cutoffDate = new Date(now.getTime() - (currentPeriod * 24 * 60 * 60 * 1000));
            
            const filteredBills = allBills.filter(bill => {
                const billDate = bill.created_at?.toDate() || new Date(bill.date);
                return billDate >= cutoffDate;
            });

            analyzeData(filteredBills);
        }

        function analyzeData(bills) {
            const total = bills.reduce((sum, bill) => sum + parseFloat(bill.amount || 0), 0);
            const avg = bills.length > 0 ? total / bills.length : 0;
            const frequency = bills.length > 0 ? (bills.length / currentPeriod).toFixed(1) : 0;
            
            // Category breakdown
            const categories = {};
            bills.forEach(bill => {
                const cat = bill.category || 'miscellaneous';
                categories[cat] = (categories[cat] || 0) + parseFloat(bill.amount || 0);
            });

            // Update stats
            document.getElementById('totalSpending').textContent = total.toFixed(0);
            document.getElementById('billCount').textContent = bills.length;
            document.getElementById('avgBill').textContent = avg.toFixed(0);
            document.getElementById('categoryCount').textContent = Object.keys(categories).length;
            document.getElementById('frequency').textContent = frequency;
            
            updateCategoryChart(categories);
            updateTimelineChart(bills);
            updateWeeklyChart(bills);
            updateCategoryDetails(categories);
        }

        function updateCategoryChart(categories) {
            const ctx = document.getElementById('categoryChart');
            if (charts.category) charts.category.destroy();
            
            const data = Object.entries(categories).map(([cat, amount]) => ({
                category: cat,
                amount: amount,
                color: categoryColors[cat] || '#64748b'
            }));

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => `${categoryIcons[d.category]} ${d.category}`),
                    datasets: [{
                        data: data.map(d => d.amount),
                        backgroundColor: data.map(d => d.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Inter' } } },
                        tooltip: {
                            callbacks: {
                                label: (context) => `â‚¬${context.parsed.toFixed(2)}`
                            }
                        }
                    }
                }
            });
        }

        function updateTimelineChart(bills) {
            const ctx = document.getElementById('timelineChart');
            if (charts.timeline) charts.timeline.destroy();
            
            // Group by date
            const daily = {};
            bills.forEach(bill => {
                const date = (bill.created_at?.toDate() || new Date(bill.date)).toLocaleDateString();
                daily[date] = (daily[date] || 0) + parseFloat(bill.amount || 0);
            });

            const sortedDates = Object.keys(daily).sort((a, b) => new Date(a) - new Date(b));
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Daily Spending',
                        data: sortedDates.map(date => daily[date]),
                        borderColor: '#5B9FED',
                        backgroundColor: 'rgba(91, 159, 237, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `â‚¬${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (value) => 'â‚¬' + value } }
                    }
                }
            });
        }

        function updateWeeklyChart(bills) {
            const ctx = document.getElementById('weeklyChart');
            if (charts.weekly) charts.weekly.destroy();
            
            const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const weekly = Array(7).fill(0);
            
            bills.forEach(bill => {
                const day = (bill.created_at?.toDate() || new Date(bill.date)).getDay();
                weekly[day] += parseFloat(bill.amount || 0);
            });

            charts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekdays,
                    datasets: [{
                        label: 'Spending by Day',
                        data: weekly,
                        backgroundColor: '#5DD5C3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `â‚¬${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (value) => 'â‚¬' + value } }
                    }
                }
            });
        }

        function updateCategoryDetails(categories) {
            const total = Object.values(categories).reduce((sum, val) => sum + val, 0);
            const container = document.getElementById('categoryDetails');
            
            container.innerHTML = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, amount]) => {
                    const percentage = ((amount / total) * 100).toFixed(1);
                    const icon = categoryIcons[cat] || 'ðŸ“¦';
                    const color = categoryColors[cat] || '#64748b';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-semibold text-gray-800 capitalize">${cat}</div>
                                    <div class="text-sm text-gray-500">${percentage}% of total</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold" style="color: ${color}">â‚¬${amount.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Tab switching
        const tabs = {
            category: { btn: 'categoryTab', view: 'categoryView' },
            timeline: { btn: 'timelineTab', view: 'timelineView' },
            weekly: { btn: 'weeklyTab', view: 'weeklyView' }
        };

        Object.entries(tabs).forEach(([key, { btn, view }]) => {
            document.getElementById(btn).addEventListener('click', () => {
                Object.values(tabs).forEach(t => {
                    document.getElementById(t.btn).classList.remove('bg-blue-100', 'text-blue-600');
                    document.getElementById(t.btn).classList.add('text-gray-600');
                    document.getElementById(t.view).classList.add('hidden');
                });
                
                document.getElementById(btn).classList.add('bg-blue-100', 'text-blue-600');
                document.getElementById(btn).classList.remove('text-gray-600');
                document.getElementById(view).classList.remove('hidden');
            });
        });

        // Period selector
        document.getElementById('periodSelector').addEventListener('change', (e) => {
            currentPeriod = parseInt(e.target.value);
            const periodText = {
                30: '30 days',
                90: '90 days',
                180: '6 months',
                365: '1 year'
            };
            document.getElementById('periodText').textContent = periodText[currentPeriod];
            filterAndAnalyze();
        });
    </script>
</body>
</html>